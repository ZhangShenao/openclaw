# OpenClaw æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£

## æ‰§è¡Œæ‘˜è¦

OpenClaw æ˜¯ä¸€ä¸ªä¸ªäºº AI åŠ©æ‰‹ç³»ç»Ÿï¼Œä»£è¡¨äº†å½“å‰æœ€å‰æ²¿çš„ Agent å·¥ç¨‹å®è·µã€‚æœ¬æ–‡æ¡£æ·±å…¥åˆ†æå…¶æ ¸å¿ƒæ¶æ„ã€è®¾è®¡æ¨¡å¼å’Œå·¥ç¨‹å®ç°ã€‚

**æ ¸å¿ƒç‰¹å¾ï¼š**
- æœ¬åœ°ä¼˜å…ˆçš„ Gateway æ§åˆ¶å¹³é¢æ¶æ„
- å¤šä¼šè¯ã€å¤š Agent çš„åˆ†å¸ƒå¼æ‰§è¡Œæ¨¡å‹
- æ··åˆè®°å¿†ç³»ç»Ÿï¼ˆå‘é‡æœç´¢ + å…³é”®è¯æœç´¢ï¼‰
- çµæ´»çš„ Skills æ‰©å±•æœºåˆ¶
- å†…ç½®çš„ SubAgent å¹¶è¡Œä»»åŠ¡å§”æ´¾
- åŸºäº Cron çš„ä¸»åŠ¨æ€§è°ƒåº¦ç³»ç»Ÿ

---

## ä¸€ã€æ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ¶ˆæ¯é€šé“å±‚                                   â”‚
â”‚  WhatsApp | Telegram | Slack | Discord | Signal | iMessage | ...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Gateway æ§åˆ¶å¹³é¢ (WS:18789)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Sessions â”‚  â”‚ Channels â”‚  â”‚  Cron    â”‚  â”‚ Config   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pi Agent     â”‚         â”‚   CLI         â”‚         â”‚   Web UI      â”‚
â”‚  (RPC)        â”‚         â”‚   (openclaw)  â”‚         â”‚   (æ§åˆ¶ç•Œé¢)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   å·¥å…·å±‚ (Tools)   â”‚
                          â”‚  browser | canvas  â”‚
                          â”‚  nodes | memory    â”‚
                          â”‚  skills | sessions â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | è·¯å¾„ | èŒè´£ |
|------|------|------|
| **Gateway** | `src/gateway/` | WebSocket æ§åˆ¶å¹³é¢ï¼Œä¼šè¯ç®¡ç† |
| **Pi Agent** | `src/agents/` | æ ¸å¿ƒ Agent è¿è¡Œæ—¶ï¼Œå·¥å…·ç¼–æ’ |
| **Auto-Reply** | `src/auto-reply/` | æ¶ˆæ¯å¤„ç†å’Œè‡ªåŠ¨å›å¤å¼•æ“ |
| **Channels** | `src/channels/` | å¤šæ¶ˆæ¯é€šé“é€‚é…å™¨ |
| **Memory** | `src/memory/` | è®°å¿†ç´¢å¼•å’Œæ£€ç´¢ç³»ç»Ÿ |
| **Cron** | `src/cron/` | å®šæ—¶ä»»åŠ¡å’Œä¸»åŠ¨æ€§è°ƒåº¦ |
| **Skills** | `skills/` | å¯æ‰©å±•èƒ½åŠ›æ’ä»¶ |

---

## äºŒã€Agent æ ¸å¿ƒè®¾è®¡

### 2.1 Agent ç”Ÿå‘½å‘¨æœŸ

**å…¥å£ç‚¹**: `src/commands/agent.ts:agentCommand()`

```
ç”¨æˆ·æ¶ˆæ¯ â†’ ä¼šè¯è§£æ â†’ æ¨¡å‹é€‰æ‹© â†’ Agent åˆå§‹åŒ– â†’ å·¥å…·ç¼–æ’ â†’ å“åº”ç”Ÿæˆ
```

**ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ**ï¼š

1. **åˆå§‹åŒ–é˜¶æ®µ** (`src/auto-reply/reply/agent-runner.ts`)
   - åˆ›å»ºæ‰“å­—ä¿¡å·å™¨ (`createTypingSignaler`)
   - è®¾ç½®å·¥å…·è¾“å‡ºè¿‡æ»¤å™¨
   - åŠ è½½ä¼šè¯çŠ¶æ€

2. **æ‰§è¡Œé˜¶æ®µ** (`src/auto-reply/reply/agent-runner-execution.ts`)
   - å¸¦é™çº§çš„æ¨¡å‹å›é€€ (`runWithModelFallback`)
   - åµŒå…¥å¼ Pi Agent æ‰§è¡Œ (`runEmbeddedPiAgent`)
   - ä¸Šä¸‹æ–‡æº¢å‡ºæ¢å¤

3. **å“åº”å¤„ç†** (`src/auto-reply/reply/agent-runner-payloads.ts`)
   - å“åº”è´Ÿè½½æ„å»º
   - å—æµå¼å¤„ç†
   - éŸ³é¢‘/TTS è½¬æ¢

### 2.2 ä¼šè¯æ¨¡å‹

**ä¼šè¯å­˜å‚¨**: `src/config/sessions/store.ts`

```typescript
interface SessionEntry {
  agentId: string;
  channelKey: string;
  accountId: string;
  skillsSnapshot: SkillsSnapshot;
  createdAt: number;
  lastActiveAt: number;
  // ...
}
```

**ä¼šè¯ç±»å‹**:
- `main`: ä¸»ä¼šè¯ï¼Œç›´æ¥å¯¹è¯
- `group`: ç¾¤ç»„éš”ç¦»ä¼šè¯
- `subagent`: å­ä»£ç†ä¼šè¯ (`agent:<agentId>:subagent:<uuid>`)
- `isolated`: éš”ç¦»çš„å®šæ—¶ä»»åŠ¡ä¼šè¯

### 2.3 ç³»ç»Ÿ Prompt æ¶æ„

**æ„å»ºå™¨**: `src/agents/system-prompt.ts:buildAgentSystemPrompt()`

**Prompt æ¨¡å¼**:
- `full`: å®Œæ•´ç³»ç»Ÿæç¤ºï¼ˆä¸» Agentï¼‰
- `minimal`: ç²¾ç®€ç‰ˆï¼ˆSubAgentï¼‰
- `none`: ä»…åŸºç¡€èº«ä»½è¡Œ

**æ ¸å¿ƒç« èŠ‚**:
```typescript
const sections = [
  "## Tooling",        // å·¥å…·åˆ—è¡¨å’Œè¯´æ˜
  "## Tool Call Style", // å·¥å…·è°ƒç”¨é£æ ¼æŒ‡å—
  "## Safety",         // å®‰å…¨çº¦æŸ
  "## Skills",         // Skills æ‰«ææŒ‡ä»¤
  "## Memory Recall",  // è®°å¿†æ£€ç´¢æŒ‡ä»¤
  "## Workspace",      // å·¥ä½œç›®å½•ä¸Šä¸‹æ–‡
  "## Runtime",        // è¿è¡Œæ—¶ä¿¡æ¯
  "## Heartbeats",     // å¿ƒè·³å“åº”æŒ‡ä»¤
  // ...
];
```

---

## ä¸‰ã€å·¥å…·ç³»ç»Ÿ (Tools)

### 3.1 å·¥å…·æ‰§è¡Œæ¶æ„

**å¤„ç†æµç¨‹**: `src/agents/pi-embedded-subscribe.handlers.tools.ts`

```
å·¥å…·è°ƒç”¨è¯·æ±‚ â†’ å·¥å…·åç§°è§„èŒƒåŒ– â†’ æƒé™æ£€æŸ¥ â†’ æ‰§è¡Œå¤„ç†å™¨ â†’ äº‹ä»¶å‘å°„ â†’ ç»“æœè¿”å›
```

**å·¥å…·ç”Ÿå‘½å‘¨æœŸäº‹ä»¶**:
```typescript
interface AgentToolEvent {
  phase: "start" | "update" | "end";
  name: string;
  toolCallId: string;
  args?: Record<string, unknown>;
  result?: unknown;
}
```

### 3.2 æ ¸å¿ƒå·¥å…·æ¸…å•

| å·¥å…·å | åŠŸèƒ½ | æ–‡ä»¶ |
|--------|------|------|
| `read` | è¯»å–æ–‡ä»¶å†…å®¹ | Pi å†…ç½® |
| `write` | åˆ›å»º/è¦†ç›–æ–‡ä»¶ | Pi å†…ç½® |
| `edit` | ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶ | Pi å†…ç½® |
| `grep` | æœç´¢æ–‡ä»¶å†…å®¹ | Pi å†…ç½® |
| `exec` | æ‰§è¡Œ Shell å‘½ä»¤ | Pi å†…ç½® |
| `web_search` | Web æœç´¢ï¼ˆBrave APIï¼‰ | - |
| `browser` | æ§åˆ¶ä¸“ç”¨æµè§ˆå™¨ | `src/agents/tools/browser-tool.ts` |
| `canvas` | æ§åˆ¶ Canvas ç•Œé¢ | - |
| `nodes` | é…å¯¹èŠ‚ç‚¹æ§åˆ¶ | - |
| `cron` | å®šæ—¶ä»»åŠ¡ç®¡ç† | `src/agents/tools/cron-tool.ts` |
| `message` | å‘é€æ¶ˆæ¯å’Œé¢‘é“æ“ä½œ | `src/agents/tools/message-tool.ts` |
| `sessions_spawn` | ç”Ÿæˆå­ä»£ç† | `src/agents/tools/sessions-spawn-tool.ts` |
| `memory_search` | è®°å¿†æœç´¢ | `src/agents/tools/memory-tool.ts` |
| `memory_get` | è·å–è®°å¿†å†…å®¹ | `src/agents/tools/memory-tool.ts` |

### 3.3 å·¥å…·ç­–ç•¥ç®¡ç†

**æƒé™æ§åˆ¶**:
- ä¼šè¯çº§å·¥å…·ç­–ç•¥
- é€šé“çº§å·¥å…·é™åˆ¶
- æ²™ç›’ç¯å¢ƒå·¥å…·è¿‡æ»¤

**å®‰å…¨çº¦æŸ**:
```typescript
// system-prompt.ts ä¸­çš„å®‰å…¨ç« èŠ‚
"## Safety",
"You have no independent goals: do not pursue self-preservation, " +
"replication, resource acquisition, or power-seeking; " +
"avoid long-term plans beyond the user's request."
```

---

## å››ã€Skills ç³»ç»Ÿ

### 4.1 Skill å®šä¹‰ç»“æ„

**Skill å…ƒæ•°æ®** (`skills/<name>/SKILL.md`):

```markdown
---
name: github
description: "Interact with GitHub using the `gh` CLI"
metadata:
  openclaw:
    emoji: "ğŸ™"
    requires:
      bins: ["gh"]
    install:
      - kind: brew
        formula: gh
        bins: ["gh"]
---

# GitHub Skill
ä½¿ç”¨è¯´æ˜...
```

### 4.2 Skill å‘ç°ä¸åŠ è½½

**åŠ è½½é¡ºåº** (ä¼˜å…ˆçº§ä»ä½åˆ°é«˜):

```
extraDirs â†’ bundled â†’ managed â†’ workspace â†’ plugins
```

**åŠ è½½å™¨**: `src/agents/skills/workspace.ts:loadSkillEntries()`

```typescript
const sources = {
  extra: loadFromExtraDirs(),
  bundled: loadFromBundledDir(),
  managed: loadFromManagedDir(),
  workspace: loadFromWorkspaceDir(),
  plugins: loadFromPlugins()
};
// åˆå¹¶æ—¶ workspace è¦†ç›–åŒå skill
```

### 4.3 Skill æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ

```
1. è§£æ SKILL.md frontmatter
2. æ£€æŸ¥ä¾èµ– (bins/env/config/os)
3. åº”ç”¨ç”¨æˆ·é…ç½®è¿‡æ»¤
4. è½¬æ¢ä¸º Pi å·¥å…·å®šä¹‰
5. Agent é€šè¿‡å·¥å…·æ¥å£è°ƒç”¨
```

### 4.4 Skill é…ç½®

```typescript
// openclaw.config.ts
skills: {
  allowBundled: true,           // å…è®¸å†…ç½® skills
  load: {
    extraDirs: [],              // é¢å¤–åŠ è½½ç›®å½•
  },
  entries: {
    "<skillName>": {
      enabled: true,            // å¯ç”¨/ç¦ç”¨
      apiKey: "env:MY_KEY",     // API å¯†é’¥æ³¨å…¥
    }
  }
}
```

---

## äº”ã€è®°å¿†ç³»ç»Ÿ

### 5.1 æ··åˆè®°å¿†æ¶æ„

**ç»„ä»¶å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Memory Manager                            â”‚
â”‚  (src/memory/manager.ts)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ File Watcher â”‚  â”‚ Indexer      â”‚  â”‚ Searcher     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vector Search â”‚   â”‚ BM25 Search   â”‚   â”‚ Hybrid Ranker â”‚
â”‚ (è¯­ä¹‰ç›¸ä¼¼åº¦)   â”‚   â”‚ (å…³é”®è¯åŒ¹é…)   â”‚   â”‚ (èåˆæ’åº)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å­˜å‚¨åç«¯

**é»˜è®¤**: SQLite + sqlite-vec
- è·¯å¾„: `~/.openclaw/memory/<agentId>.sqlite`
- å‘é‡ç´¢å¼•: è‡ªåŠ¨åˆ›å»º

**è®°å¿†æº**:
- `memory`: å·¥ä½œåŒº Markdown æ–‡ä»¶ (MEMORY.md, memory/*.md)
- `sessions`: ä¼šè¯è®°å½• (å®éªŒæ€§)

### 5.3 åµŒå…¥æä¾›è€…

```typescript
// src/memory/embeddings.ts
type EmbeddingProvider =
  | "openai"      // text-embedding-3-small
  | "gemini"      // gemini-embedding-001
  | "voyage"      // voyage-4-large
  | "local"       // node-llama-cpp + GGUF
  | "auto";       // è‡ªåŠ¨é€‰æ‹©
```

### 5.4 æ··åˆæœç´¢é…ç½®

```typescript
memorySearch: {
  query: {
    hybrid: {
      enabled: true,
      vectorWeight: 0.7,    // å‘é‡æœç´¢æƒé‡
      textWeight: 0.3,      // å…³é”®è¯æœç´¢æƒé‡
    }
  },
  chunking: {
    tokens: 400,            // åˆ†å—å¤§å°
    overlap: 80,            // é‡å å¤§å°
  },
  cache: {
    enabled: true,
    maxEntries: 50000,
  }
}
```

### 5.5 è®°å¿†æ£€ç´¢æŒ‡ä»¤

**ç³»ç»Ÿ Prompt ä¸­çš„æŒ‡ä»¤**:
```markdown
## Memory Recall
Before answering anything about prior work, decisions, dates, people, preferences, or todos:
run memory_search on MEMORY.md + memory/*.md; then use memory_get to pull only the needed lines.
If low confidence after search, say you checked.
```

---

## å…­ã€SubAgent ç³»ç»Ÿ

### 6.1 SubAgent æ¶æ„

**æ³¨å†Œè¡¨**: `src/agents/subagent-registry.ts`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Main Agent                                â”‚
â”‚  "If a task is more complex or takes longer, spawn a        â”‚
â”‚   sub-agent. It will do the work for you and ping you       â”‚
â”‚   when it's done."                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    sessions_spawn tool
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SubAgent Registry                               â”‚
â”‚  - æœ€å¤š 8 ä¸ªå¹¶å‘ SubAgent                                    â”‚
â”‚  - ä¼šè¯æ ¼å¼: agent:<id>:subagent:<uuid>                      â”‚
â”‚  - å·¥å…·ç­–ç•¥: é»˜è®¤æ’é™¤ä¼šè¯å·¥å…·                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SubAgent #1   â”‚   â”‚ SubAgent #2   â”‚   â”‚ SubAgent #3   â”‚
â”‚ (ç‹¬ç«‹ä¼šè¯)     â”‚   â”‚ (ç‹¬ç«‹ä¼šè¯)     â”‚   â”‚ (ç‹¬ç«‹ä¼šè¯)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Result Announce  â”‚
                  â”‚  (å›ä¼ ç»™è¯·æ±‚è€…)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ä»»åŠ¡å§”æ´¾

**Tool å‚æ•°**: `sessions_spawn`
```typescript
{
  task: "å…·ä½“ä»»åŠ¡æè¿°",
  label?: "å¯é€‰æ ‡ç­¾",
  agentId?: "ç›®æ ‡ agent ID",
  model?: "æ¨¡å‹è¦†ç›–",
  thinking?: "thinking çº§åˆ«",
  runTimeoutSeconds?: 1800,  // 30åˆ†é’Ÿ
  cleanup?: "delete" | "keep"
}
```

### 6.3 ç»“æœå…¬å‘Šç³»ç»Ÿ

**å…¬å‘Šæµç¨‹** (`src/agents/subagent-announce.ts`):

```
1. SubAgent å®Œæˆä»»åŠ¡ â†’ ç”Ÿæˆæ‘˜è¦
2. åœ¨ SubAgent ä¼šè¯ä¸­è¿è¡Œå…¬å‘Šæµç¨‹
3. å‘å¸ƒç»“æœåˆ°è¯·æ±‚è€…çš„èŠå¤©é¢‘é“
4. ä¿ç•™çº¿ç¨‹/è¯é¢˜è·¯ç”±ä¸Šä¸‹æ–‡
```

**æ¶ˆæ¯æ ¼å¼**:
```
Status: [completed successfully/timed out/failed]
Findings: [SubAgent çš„æ‘˜è¦]
Stats: runtime X tokens Y est $Z
sessionKey [sessionId] transcript [path]
```

### 6.4 é˜Ÿåˆ—æ¨¡å¼

- `steer`: ç›´æ¥æ³¨å…¥åˆ°å½“å‰å¯¹è¯
- `followup`: åœ¨å½“å‰ä»»åŠ¡åæ’é˜Ÿ
- `collect`: æ‰¹é‡å¤šä¸ªå…¬å‘Š
- `interrupt`: ä¸­æ–­å½“å‰å¯¹è¯

---

## ä¸ƒã€ä¸»åŠ¨æ€§ç³»ç»Ÿ

### 7.1 å¿ƒè·³æœºåˆ¶

**å¿ƒè·³è¿è¡Œå™¨**: `src/infra/heartbeat-runner.ts`

```typescript
const HEARTBEAT_PROMPT =
  "Read HEARTBEAT.md if it exists (workspace context). " +
  "Follow it strictly. " +
  "Do not infer or repeat old tasks from prior chats. " +
  "If nothing needs attention, reply HEARTBEAT_OK.";
```

**å·¥ä½œæµç¨‹**:
```
æ¯ 30 åˆ†é’Ÿ â†’ è¯»å– HEARTBEAT.md â†’ å‘é€å¿ƒè·³æ¶ˆæ¯ â†’ Agent å¤„ç† â†’ HEARTBEAT_OK æˆ–æ‰§è¡Œä»»åŠ¡
```

### 7.2 Cron å®šæ—¶ç³»ç»Ÿ

**æœåŠ¡**: `src/cron/service/jobs.ts`

**è°ƒåº¦ç±»å‹**:
```typescript
type CronSchedule =
  | { kind: "at"; at: string }           // ç»å¯¹æ—¶é—´ï¼ˆä¸€æ¬¡æ€§ï¼‰
  | { kind: "every"; everyMs: number }   // é—´éš”æ‰§è¡Œ
  | { kind: "cron"; cron: string };      // æ ‡å‡† cron è¡¨è¾¾å¼
```

**æ‰§è¡Œæ¨¡å¼**:
- `main`: æ³¨å…¥ç³»ç»Ÿäº‹ä»¶åˆ°ä¸»ä¼šè¯
- `isolated`: ç”Ÿæˆç‹¬ç«‹çš„å­ä»£ç†ä¼šè¯

**é…ç½®ç¤ºä¾‹**:
```typescript
cron: {
  jobs: [
    {
      name: "daily-standup",
      schedule: { kind: "cron", cron: "0 9 * * 1-5" },
      payload: {
        kind: "systemEvent",
        text: "It's 9am on a weekday. Time for daily standup summary."
      },
      sessionTarget: "main"
    },
    {
      name: "weekly-report",
      schedule: { kind: "every"; everyMs: 7 * 24 * 60 * 60 * 1000 },
      payload: { kind: "agentTurn", text: "Generate weekly report..." },
      sessionTarget: "isolated",
      delivery: { mode: "followup" }
    }
  ]
}
```

### 7.3 æ¶ˆæ¯ç›‘æ§

**ç›‘æ§å™¨**: `src/web/inbound/monitor.ts`

```
å®æ—¶ç›‘å¬ â†’ æƒé™éªŒè¯ â†’ å»é‡ â†’ å›å£°æ£€æµ‹ â†’ å¤„ç†
```

### 7.4 ä¸»åŠ¨æ€§çº¦æŸ

**ç³»ç»Ÿ Prompt å®‰å…¨çº¦æŸ**:
```markdown
## Safety
You have no independent goals: do not pursue self-preservation,
replication, resource acquisition, or power-seeking;
avoid long-term plans beyond the user's request.
```

---

## å…«ã€æ¶ˆæ¯è·¯ç”±ä¸äº¤ä»˜

### 8.1 é€šé“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Channel Router                            â”‚
â”‚                    (src/routing/)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚WhatsApp  â”‚  â”‚Telegram  â”‚  â”‚ Slack    â”‚  â”‚ Discord  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Signal   â”‚  â”‚iMessage  â”‚  â”‚ Teams    â”‚  â”‚ WebChat  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Agent ID    â”‚
                    â”‚   Resolution  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Target Agent â”‚
                    â”‚  + Workspace  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ç¾¤ç»„è·¯ç”±

**ç‰¹æ€§**:
- æåŠç½‘å…³ (`@clawbot` æˆ–é…ç½®)
- å›å¤æ ‡ç­¾ (`[[reply_to_current]]`, `[[reply_to:<id>]]`)
- ç¾¤ç»„éš”ç¦»ï¼ˆæ¯ä¸ªç¾¤ç»„ç‹¬ç«‹ä¼šè¯ï¼‰

### 8.3 æµå¼å¤„ç†

**å—æµå¼** (`src/auto-reply/reply/block-streaming.ts`):
- åˆ†å—å‘é€å¤§å“åº”
- å¯é…ç½®å—å¤§å°å’Œæ–­ç‚¹åå¥½
- è‡ªåŠ¨åˆå¹¶ç­–ç•¥

---

## ä¹ã€é…ç½®ç³»ç»Ÿ

### 9.1 é…ç½®å±‚çº§

```
å…¨å±€é…ç½® (~/.openclaw/config.ts)
    â”‚
    â”œâ”€â”€ Agent çº§è¦†ç›– (agents.<id>)
    â”‚       â”‚
    â”‚       â””â”€â”€ ä¼šè¯çº§è¦†ç›–
    â”‚
    â””â”€â”€ é€šé“çº§é…ç½®
```

### 9.2 å…³é”®é…ç½®é¡¹

```typescript
export interface OpenClawConfig {
  // Agent é…ç½®
  agents?: Record<string, AgentConfig>;

  // æ¨¡å‹é…ç½®
  models?: {
    default?: string;
    fallbacks?: FallbackConfig;
  };

  // é€šé“é…ç½®
  channels?: {
    whatsapp?: WhatsAppConfig;
    telegram?: TelegramConfig;
    // ...
  };

  // Skills é…ç½®
  skills?: SkillsConfig;

  // è®°å¿†é…ç½®
  memorySearch?: MemorySearchConfig;

  // SubAgent é…ç½®
  subagents?: {
    maxConcurrent?: number;
    archiveAfterMinutes?: number;
  };

  // Cron é…ç½®
  cron?: CronConfig;

  // ç½‘å…³é…ç½®
  gateway?: GatewayConfig;
}
```

---

## åã€å…³é”®è®¾è®¡æ¨¡å¼

### 10.1 äº‹ä»¶é©±åŠ¨æ¶æ„

**äº‹ä»¶ç³»ç»Ÿ**: `src/infra/agent-events.js`

```typescript
emitAgentEvent({
  runId: string,
  stream: "tool" | "content" | "usage",
  data: unknown
});
```

### 10.2 ä¾èµ–æ³¨å…¥

**æ¨¡å¼**: `createDefaultDeps()`
- ä¾¿äºæµ‹è¯•
- è¿è¡Œæ—¶å¯æ›¿æ¢

### 10.3 å›é€€æœºåˆ¶

**æ¨¡å‹å›é€€**: `src/auto-reply/reply/agent-runner-execution.ts`
```typescript
await runWithModelFallback({
  provider, model,
  fallbacksOverride,
  run: (providerOverride, modelOverride) => {
    return runEmbeddedPiAgent({...});
  }
});
```

### 10.4 æ²™ç›’éš”ç¦»

**æ²™ç›’å·¥å…·**: Docker å®¹å™¨æ‰§è¡Œ
- å·¥ä½œåŒºæŒ‚è½½æ§åˆ¶
- ææƒ exec ç®¡ç†
- æµè§ˆå™¨æ¡¥æ¥

---

## åä¸€ã€éƒ¨ç½²æ¶æ„

### 11.1 è¿è¡Œæ¨¡å¼

1. **æœ¬åœ°å¼€å‘**: `pnpm gateway:watch`
2. **ç³»ç»ŸæœåŠ¡**: launchd/systemd
3. **Docker**: `docker-compose.yml`
4. **macOS App**: èœå•æ åº”ç”¨

### 11.2 è¿œç¨‹è®¿é—®

- **Tailscale Serve/Funnel**
- **SSH éš§é“ + Token è®¤è¯**

---

## åäºŒã€å®‰å…¨æœºåˆ¶

### 12.1 DM è®¿é—®æ§åˆ¶

é»˜è®¤ `dmPolicy="pairing"`:
- æœªçŸ¥å‘é€è€…æ”¶åˆ°é…å¯¹ç 
- éœ€è¦æ˜¾å¼æ‰¹å‡†: `openclaw pairing approve <channel> <code>`

### 12.2 å·¥å…·ç­–ç•¥

- ä¼šè¯çº§å·¥å…·ç™½åå•/é»‘åå•
- æ²™ç›’ç¯å¢ƒå·¥å…·é™åˆ¶
- å±é™©æ“ä½œäºŒæ¬¡ç¡®è®¤

---

## åä¸‰ã€æ‰©å±•ç‚¹

### 13.1 é€šé“æ’ä»¶

**æ‰©å±•ç›®å½•**: `extensions/*`
- å®ç° `ChannelProvider` æ¥å£
- æ”¯æŒè‡ªå®šä¹‰é…ç½® schema

### 13.2 è‡ªå®šä¹‰ Skills

```bash
~/.openclaw/skills/my-skill/
â”œâ”€â”€ SKILL.md
â””â”€â”€ (å¯é€‰çš„ä¾èµ–æ–‡ä»¶)
```

### 13.3 è®°å¿†æ‰©å±•

- æ”¯æŒé¢å¤–çš„ Markdown æº
- å¯è‡ªå®šä¹‰åµŒå…¥æä¾›è€…
- LanceDB é›†æˆï¼ˆå®éªŒæ€§ï¼‰

---

## åå››ã€æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•

| åŠŸèƒ½æ¨¡å— | å…³é”®æ–‡ä»¶ |
|----------|----------|
| **Agent æ ¸å¿ƒ** | `src/agents/system-prompt.ts`, `src/agents/pi-embedded.ts` |
| **ä¼šè¯ç®¡ç†** | `src/config/sessions/store.ts`, `src/auto-reply/reply/agent-runner.ts` |
| **å·¥å…·ç³»ç»Ÿ** | `src/agents/tools/*.ts`, `src/agents/pi-embedded-subscribe.handlers.tools.ts` |
| **Skills** | `src/agents/skills/workspace.ts`, `skills/` |
| **è®°å¿†ç³»ç»Ÿ** | `src/memory/manager.ts`, `src/memory/embeddings.ts` |
| **SubAgent** | `src/agents/subagent-registry.ts`, `src/agents/subagent-announce.ts` |
| **Cron** | `src/cron/service/jobs.ts`, `src/infra/heartbeat-runner.ts` |
| **é€šé“** | `src/channels/*.ts`, `src/routing/` |
| **é…ç½®** | `src/config/types.ts`, `src/config/load.ts` |

---

## åäº”ã€æŠ€æœ¯æ ˆæ€»ç»“

| ç±»åˆ« | æŠ€æœ¯ |
|------|------|
| **è¿è¡Œæ—¶** | Node.js 22+, TypeScript (ESM) |
| **Agent æ¡†æ¶** | Pi (åµŒå…¥å¼) |
| **å­˜å‚¨** | SQLite, sqlite-vec |
| **åµŒå…¥** | OpenAI, Gemini, Voyage, Local (node-llama-cpp) |
| **æ¶ˆæ¯åº“** | Baileys (WA), grammY (TG), Bolt (Slack), discord.js |
| **æ‰“åŒ…** | esbuild, pkg |
| **æµ‹è¯•** | Vitest |
| **å‰ç«¯** | Solid.js (Web UI) |
| **ç§»åŠ¨ç«¯** | Swift (iOS), Kotlin (Android) |

---

## æ€»ç»“

OpenClaw ä»£è¡¨äº†ä¸ªäºº AI åŠ©æ‰‹çš„å·¥ç¨‹åŒ–æœ€ä½³å®è·µï¼š

1. **æœ¬åœ°ä¼˜å…ˆ**: Gateway æ§åˆ¶å¹³é¢å®Œå…¨åœ¨æœ¬åœ°è¿è¡Œ
2. **å¯æ‰©å±•**: Skills å’Œæ’ä»¶ç³»ç»Ÿæ”¯æŒæ— é™æ‰©å±•
3. **å¤šæ™ºèƒ½ä½“**: SubAgent ç³»ç»Ÿæ”¯æŒå¤æ‚ä»»åŠ¡åˆ†è§£
4. **æŒä¹…è®°å¿†**: æ··åˆæœç´¢å®ç°é•¿æœŸè®°å¿†
5. **ä¸»åŠ¨æ€§**: Cron + å¿ƒè·³å®ç°ä¸»åŠ¨è¡Œä¸º
6. **å¤šé€šé“**: ç»Ÿä¸€è·¯ç”±æ”¯æŒ 15+ æ¶ˆæ¯å¹³å°
7. **å®‰å…¨**: é…å¯¹ç­–ç•¥å’Œå·¥å…·ç­–ç•¥ä¿éšœå®‰å…¨

è¯¥é¡¹ç›®ä¸ºæ„å»ºç”Ÿäº§çº§ AI Agent æä¾›äº†å®Œæ•´çš„å‚è€ƒæ¶æ„ã€‚
